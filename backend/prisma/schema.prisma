generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table (simplified - assuming you have existing user management)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  screenTimeBudgets ScreenTimeBudget[]
  userApps          UserApp[]
  dailyUsages       DailyAppUsage[]
  budgetAlerts      BudgetAlert[]

  @@map("users")
}

// Screen Time Budgets
model ScreenTimeBudget {
  id        String   @id @default(uuid())
  userId    String
  monthYear DateTime // First day of month: 2025-01-01
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories CategoryBudget[]

  @@unique([userId, monthYear])
  @@index([userId, monthYear])
  @@map("screen_time_budgets")
}

// Category Budgets
model CategoryBudget {
  id           String   @id @default(uuid())
  budgetId     String
  categoryName String   @db.VarChar(100)
  categoryType String   @db.VarChar(50) // 'social_media', 'entertainment', etc.
  monthlyHours Decimal  @db.Decimal(6, 2)
  isExcluded   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  budget ScreenTimeBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@map("category_budgets")
}

// User Apps (detected installed apps)
model UserApp {
  id           String   @id @default(uuid())
  userId       String
  bundleId     String   @db.VarChar(255)
  appName      String   @db.VarChar(255)
  categoryType String?  @db.VarChar(50)
  isExcluded   Boolean  @default(false)
  lastDetected DateTime @default(now())
  createdAt    DateTime @default(now())

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyUsages DailyAppUsage[]

  @@unique([userId, bundleId])
  @@index([userId])
  @@index([userId, categoryType])
  @@map("user_apps")
}

// Daily Usage Records
model DailyAppUsage {
  id           String   @id @default(uuid())
  userId       String
  appId        String
  usageDate    DateTime @db.Date
  totalMinutes Int
  syncedAt     DateTime @default(now())

  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  app  UserApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([userId, appId, usageDate])
  @@index([userId, usageDate])
  @@index([appId, usageDate])
  @@map("daily_app_usage")
}

// Budget Alerts History
model BudgetAlert {
  id             String    @id @default(uuid())
  userId         String
  categoryType   String    @db.VarChar(50)
  alertDate      DateTime  @db.Date
  overageMinutes Int
  alertSentAt    DateTime  @default(now())
  wasDismissed   Boolean   @default(false)
  dismissedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, alertDate])
  @@map("budget_alerts")
}
