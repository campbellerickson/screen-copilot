generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Hashed password (null for Apple Sign In only)
  name          String?
  appleId       String?   @unique // Apple Sign In identifier
  profileImage  String?   // URL to profile image
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  screenTimeBudgets ScreenTimeBudget[]
  userApps          UserApp[]
  dailyUsages       DailyAppUsage[]
  budgetAlerts      BudgetAlert[]
  subscription      Subscription?

  @@map("users")
}

// Subscription management
model Subscription {
  id                    String    @id @default(uuid())
  userId                String    @unique
  status                String    @db.VarChar(20) // 'trial', 'active', 'expired', 'cancelled'
  platform              String    @db.VarChar(20) // 'ios', 'android', 'web'

  // Trial tracking
  trialStartDate        DateTime?
  trialEndDate          DateTime?

  // Subscription tracking
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  renewalDate           DateTime?

  // Payment provider info
  stripeCustomerId      String?   @unique // For web subscriptions
  stripeSubscriptionId  String?   @unique
  appleTransactionId    String?   @unique // For iOS subscriptions
  appleOriginalTransactionId String? @unique

  // Pricing
  priceUSD              Decimal   @default(0.99) @db.Decimal(5, 2)
  currency              String    @default("USD") @db.VarChar(3)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// Screen Time Budgets
model ScreenTimeBudget {
  id        String   @id @default(uuid())
  userId    String
  monthYear DateTime // First day of month: 2025-01-01
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories CategoryBudget[]

  @@unique([userId, monthYear])
  @@index([userId, monthYear])
  @@map("screen_time_budgets")
}

// Category Budgets
model CategoryBudget {
  id           String   @id @default(uuid())
  budgetId     String
  categoryName String   @db.VarChar(100)
  categoryType String   @db.VarChar(50) // 'social_media', 'entertainment', etc.
  monthlyHours Decimal  @db.Decimal(6, 2)
  isExcluded   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  budget ScreenTimeBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@map("category_budgets")
}

// User Apps (detected installed apps)
model UserApp {
  id           String   @id @default(uuid())
  userId       String
  bundleId     String   @db.VarChar(255)
  appName      String   @db.VarChar(255)
  categoryType String?  @db.VarChar(50)
  isExcluded   Boolean  @default(false)
  lastDetected DateTime @default(now())
  createdAt    DateTime @default(now())

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyUsages DailyAppUsage[]

  @@unique([userId, bundleId])
  @@index([userId])
  @@index([userId, categoryType])
  @@map("user_apps")
}

// Daily Usage Records
model DailyAppUsage {
  id           String   @id @default(uuid())
  userId       String
  appId        String
  usageDate    DateTime @db.Date
  totalMinutes Int
  syncedAt     DateTime @default(now())

  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  app  UserApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([userId, appId, usageDate])
  @@index([userId, usageDate])
  @@index([appId, usageDate])
  @@map("daily_app_usage")
}

// Budget Alerts History
model BudgetAlert {
  id             String    @id @default(uuid())
  userId         String
  categoryType   String    @db.VarChar(50)
  alertDate      DateTime  @db.Date
  overageMinutes Int
  alertSentAt    DateTime  @default(now())
  wasDismissed   Boolean   @default(false)
  dismissedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, alertDate])
  @@map("budget_alerts")
}
