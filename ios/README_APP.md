# Screen Time Budget - iOS App Documentation

**Last Updated:** January 2, 2026
**App Version:** 1.0.0 (MVP)
**iOS Target:** 16.0+

---

## Table of Contents

1. [What This App Does](#what-this-app-does)
2. [Current Architecture](#current-architecture)
3. [File Structure Explained](#file-structure-explained)
4. [How the App Works](#how-the-app-works)
5. [Data Flow](#data-flow)
6. [Key Components](#key-components)
7. [API Integration](#api-integration)
8. [Screen Time Integration](#screen-time-integration)
9. [Configuration](#configuration)
10. [Building & Running](#building--running)
11. [What's Implemented](#whats-implemented)
12. [Known Limitations](#known-limitations)
13. [Troubleshooting](#troubleshooting)

---

## What This App Does

**Screen Time Budget** is a digital wellness app that helps users manage their screen time by setting monthly budgets for different app categories.

### Core Functionality:

1. **Request Screen Time Permission** - App asks user for permission to access iOS Screen Time data
2. **Set Monthly Budgets** - User sets time limits (hours/month) for categories like Social Media, Entertainment, Gaming, etc.
3. **Track Daily Usage** - App monitors how much time user spends in each app category daily
4. **Sync to Backend** - Usage data syncs to backend API every 15 minutes
5. **Alert on Overage** - User gets notifications when they exceed their daily budget limit
6. **Dashboard View** - Visual display of usage vs budget with progress bars and category breakdowns

### User Journey:

```
User opens app
  → Grant Screen Time permission (one-time)
  → App auto-detects installed apps
  → User sets monthly budgets per category (e.g., 30 hrs/month for Social Media)
  → App calculates daily budget (30 hrs ÷ 30 days = 1 hr/day)
  → Background monitoring starts
  → App syncs usage data to backend every 15 min
  → If user exceeds daily limit, notification sent
  → User views dashboard to see usage breakdown
```

---

## Current Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    iOS App (Swift/SwiftUI)               │
│                                                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│  │   Views    │  │ ViewModels │  │  Services  │        │
│  │  (UI/UX)   │←→│  (Logic)   │←→│(API/Screen)│        │
│  └────────────┘  └────────────┘  └────────────┘        │
│         ↓              ↓                ↓               │
│  ┌────────────────────────────────────────────┐        │
│  │           Models (Data Structures)          │        │
│  └────────────────────────────────────────────┘        │
│                       ↓                                  │
└───────────────────────┼──────────────────────────────────┘
                        ↓
          ┌─────────────────────────┐
          │  iOS Screen Time APIs   │
          │  - FamilyControls       │
          │  - DeviceActivity       │
          └─────────────────────────┘
                        ↓
          ┌─────────────────────────┐
          │   Backend API (Node.js) │
          │   PostgreSQL Database   │
          └─────────────────────────┘
```

---

## File Structure Explained

```
ScreenTimeBudget/
├── ScreenTimeBudgetApp.swift         # App entry point (@main)
├── ContentView.swift                  # Default placeholder view (to be replaced)
│
├── Models/                            # Data structures
│   ├── ScreenTimeBudget.swift        # Budget & category models
│   ├── AppUsage.swift                # Usage tracking models
│   └── BudgetStatus.swift            # Status & sync response models
│
├── Services/                          # External integrations
│   └── APIService.swift              # Backend API communication
│
├── Utilities/                         # Helpers & configuration
│   ├── Constants.swift               # App config, CategoryType enum
│   └── Analytics.swift               # Analytics placeholder
│
├── Views/                             # UI components (TO BE CREATED)
│   ├── OnboardingView.swift          # Permission request flow
│   ├── BudgetSetupView.swift         # Set monthly budgets
│   ├── DashboardView.swift           # Main usage dashboard
│   └── SettingsView.swift            # App settings
│
├── ViewModels/                        # Business logic (TO BE CREATED)
│   ├── BudgetViewModel.swift         # Budget management logic
│   └── UsageViewModel.swift          # Usage tracking logic
│
└── Resources/
    └── Assets.xcassets               # App icons, colors, images

ScreenTimeReportExtension/             # Device Activity Extension
└── (Auto-generated by Xcode)         # Handles Screen Time monitoring
```

---

## How the App Works

### 1. App Launch (`ScreenTimeBudgetApp.swift`)

```swift
@main
struct ScreenTimeBudgetApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView() // Entry point
        }
    }
}
```

**Current State:** App shows default `ContentView`. This will be replaced with:
- Onboarding flow (if first launch)
- Dashboard (if already set up)

---

### 2. Screen Time Permission Request

**Framework:** `FamilyControls`

**Flow:**
1. App requests authorization to access Screen Time data
2. iOS shows system permission dialog
3. User grants/denies permission
4. App stores authorization state

**Code Location:** Not yet implemented (will be in `OnboardingView.swift`)

**iOS API:**
```swift
import FamilyControls

let center = AuthorizationCenter.shared
try await center.requestAuthorization(for: .individual)
```

---

### 3. Budget Setup

**User Input:**
- Select category (Social Media, Entertainment, etc.)
- Set monthly hours budget (e.g., 30 hours)

**Data Flow:**
```
User sets budget in UI
  → ViewModel validates input
  → Create CategoryBudgetInput objects
  → APIService.createBudget() called
  → POST to backend /api/v1/screen-time/budgets
  → Backend saves to PostgreSQL
  → Response returned with budget ID
  → App stores budget locally (optional)
```

**API Call Example:**
```swift
let categories = [
    CategoryBudgetInput(
        categoryType: .socialMedia,
        categoryName: "Social Media",
        monthlyHours: 30.0,
        isExcluded: false
    )
]

let budget = try await apiService.createBudget(
    userId: "user-123",
    monthYear: Date(),
    categories: categories
)
```

---

### 4. App Usage Monitoring

**Framework:** `DeviceActivity`

**How It Works:**
1. **Device Activity Extension** runs in background (even when app closed)
2. iOS monitors app usage via Screen Time framework
3. Extension collects usage data for installed apps
4. Data categorized based on bundle ID (e.g., `com.instagram.instagram` → Social Media)

**Background Sync Schedule:**
- Every 15 minutes (configurable)
- Uses `BGTaskScheduler` for background execution
- Sync only when device online

**Data Collected Per App:**
- Bundle ID (e.g., `com.netflix.Netflix`)
- App name (e.g., "Netflix")
- Total minutes used today

---

### 5. Usage Data Sync

**API Service:** `APIService.syncUsage()`

**Sync Flow:**
```
Background task triggers
  → Extension reads Screen Time data
  → Creates AppUsageDTO objects
  → APIService.syncUsage() called
  → POST to /api/v1/screen-time/usage/sync
  → Backend processes data:
      - Auto-categorizes apps
      - Calculates daily totals
      - Checks against budget
      - Creates alerts if over budget
  → Returns SyncResponse with alerts
  → App displays alerts to user
```

**Example Sync Payload:**
```json
{
  "userId": "user-123",
  "usageDate": "2026-01-02",
  "apps": [
    {
      "bundleId": "com.instagram.instagram",
      "appName": "Instagram",
      "totalMinutes": 65
    },
    {
      "bundleId": "com.netflix.Netflix",
      "appName": "Netflix",
      "totalMinutes": 120
    }
  ]
}
```

---

### 6. Budget Alerts

**Trigger:** When daily usage exceeds daily budget limit

**Calculation:**
```
Monthly Budget: 30 hours
Days in Month: 30
Daily Budget: 30 hrs ÷ 30 days = 1 hour/day = 60 minutes/day

If user spends 65 minutes on Instagram today:
  → Over budget by 5 minutes
  → Alert triggered
```

**Alert Delivery:**
1. Backend creates alert record
2. Returns alert in sync response
3. App shows local notification
4. User can dismiss alert

**Framework:** `UserNotifications`

---

### 7. Dashboard View

**Displays:**
- Today's usage per category
- Budget vs actual (progress bars)
- Over-budget categories highlighted
- Time remaining for each category
- Recent alerts

**Data Source:**
- Fetches from: `APIService.getDailyUsage(userId:date:)`
- Endpoint: `GET /api/v1/screen-time/usage/:userId/daily?date=2026-01-02`

**Response Structure:**
```json
{
  "success": true,
  "data": {
    "usageDate": "2026-01-02",
    "categories": [
      {
        "categoryType": "social_media",
        "categoryName": "Social Media",
        "totalMinutes": 65,
        "budgetMinutes": 60,
        "isOverBudget": true,
        "apps": [
          {
            "appName": "Instagram",
            "totalMinutes": 45
          },
          {
            "appName": "Twitter",
            "totalMinutes": 20
          }
        ]
      }
    ]
  }
}
```

---

## Data Flow

### Complete Data Journey:

```
┌─────────────────────────────────────────────────────────┐
│ 1. USER SETS BUDGET                                      │
│    iOS App → Backend API → PostgreSQL                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 2. BACKGROUND MONITORING                                 │
│    DeviceActivity Extension → iOS Screen Time APIs       │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 3. USAGE DATA COLLECTION                                 │
│    Extension reads app usage (every 15 min)             │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 4. SYNC TO BACKEND                                       │
│    iOS App → POST /usage/sync → Backend                 │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 5. BACKEND PROCESSING                                    │
│    - Categorize apps                                     │
│    - Calculate totals                                    │
│    - Compare to budget                                   │
│    - Generate alerts if over                             │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 6. ALERT USER                                            │
│    Backend → iOS App → Local Notification               │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 7. DISPLAY DASHBOARD                                     │
│    iOS App → GET /usage/daily → Render UI               │
└─────────────────────────────────────────────────────────┘
```

---

## Key Components

### Models (`Models/`)

#### `ScreenTimeBudget.swift`

**Purpose:** Represents user's monthly budget configuration

**Key Structures:**
- `ScreenTimeBudget` - Top-level budget object
- `CategoryBudget` - Budget for specific category
- `CategoryBudgetInput` - Input for creating budgets

**Important Properties:**
```swift
struct CategoryBudget {
    let monthlyHours: Double      // e.g., 30.0
    var dailyMinutes: Int {       // Calculated: (30 * 60) / 30 days = 60 min/day
        let daysInMonth = Calendar.current.range(of: .day, in: .month, for: Date())?.count ?? 30
        return Int((monthlyHours * 60) / Double(daysInMonth))
    }
}
```

---

#### `AppUsage.swift`

**Purpose:** Track app usage data

**Key Structures:**
- `AppUsageDTO` - Data transfer object for sync
- `UserApp` - Represents an installed app
- `DailyAppUsage` - Daily usage record per app

---

#### `BudgetStatus.swift`

**Purpose:** Response models for API calls

**Key Structures:**
- `SyncResponse` - Response from usage sync
- `BudgetStatusResponse` - Daily usage summary
- `CategoryUsage` - Usage breakdown per category

---

### Services (`Services/`)

#### `APIService.swift`

**Purpose:** Handle all backend API communication

**Key Methods:**

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `createBudget()` | POST `/budgets` | Create monthly budget |
| `getCurrentBudget()` | GET `/budgets/:userId/current` | Get active budget |
| `syncUsage()` | POST `/usage/sync` | Sync usage data |
| `getDailyUsage()` | GET `/usage/:userId/daily` | Get daily summary |
| `getUserAlerts()` | GET `/alerts/:userId` | Get alert history |

**Configuration:**
- Base URL: `http://localhost:3000/api/v1` (DEBUG mode)
- Date format: ISO8601
- Content-Type: application/json

---

### Utilities (`Utilities/`)

#### `Constants.swift`

**Purpose:** App-wide configuration and enums

**Key Constants:**
```swift
// API URLs
static let baseURL = "http://localhost:3000/api/v1"  // DEBUG
static let baseURL = "https://your-api.com/api/v1"   // RELEASE

// Background sync
static let backgroundSyncTaskIdentifier = "com.copilot.screentime.sync"

// App Groups (for extension communication)
static let appGroupIdentifier = "group.com.copilot.screentime"
```

**CategoryType Enum:**
```swift
enum CategoryType: String, Codable, CaseIterable {
    case socialMedia = "social_media"
    case entertainment = "entertainment"
    case gaming = "gaming"
    case productivity = "productivity"
    case shopping = "shopping"
    case newsReading = "news_reading"
    case healthFitness = "health_fitness"
    case other = "other"

    var displayName: String { ... }  // "Social Media", "Entertainment", etc.
    var icon: String { ... }         // SF Symbol names: "person.2.fill", "tv.fill", etc.
    var defaultBudget: Double { ... } // Default hours: 30, 40, 20, etc.
}
```

---

## API Integration

### Backend Connection

**Development Setup:**
- Backend runs on Mac: `http://localhost:3000`
- iOS Simulator uses: `http://localhost:3000/api/v1`
- Physical iPhone uses: `http://192.168.X.XXX:3000/api/v1` (Mac's local IP)

**To Find Mac's IP:**
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

**Update Constants.swift:**
```swift
#if DEBUG
static let baseURL = "http://192.168.1.100:3000/api/v1"  // Replace with your Mac's IP
#endif
```

---

### API Request Format

All requests use:
- **Content-Type:** `application/json`
- **Date Format:** ISO8601 (`2026-01-02T00:00:00Z`)
- **Response Format:**
```json
{
  "success": true,
  "data": { ... }
}
```

---

### Error Handling

**Current Implementation:**
- All API methods use `async/throws`
- Errors propagate to caller
- No automatic retry logic yet

**TODO:** Add error handling in ViewModels

---

## Screen Time Integration

### Required iOS Capabilities

**Main App (ScreenTimeBudget):**
1. ✅ Family Controls - Access Screen Time data
2. ✅ App Groups - Share data with extension
3. ✅ Background Modes - Background sync
4. ✅ Push Notifications - Alert delivery

**Extension (ScreenTimeReportExtension):**
1. ✅ App Groups - Communicate with main app

### App Groups

**Purpose:** Allow main app and extension to share data

**Identifier:** `group.com.copilot.screentime`

**Usage:**
```swift
let sharedContainer = FileManager.default.containerURL(
    forSecurityApplicationGroupIdentifier: Constants.appGroupIdentifier
)
```

---

### Screen Time Permission

**Framework:** `FamilyControls`

**Permission Description (Info.plist):**
```
NSFamilyControlsUsageDescription:
"Screen Time Budget needs access to Screen Time data to help you track and manage your app usage."
```

**User sees this message** when permission is requested.

---

### Background Task Scheduling

**Framework:** `BackgroundTasks`

**Identifier (Info.plist):**
```
BGTaskSchedulerPermittedIdentifiers:
  - com.copilot.screentime.sync
```

**Purpose:** Allow app to sync usage data in background every 15 minutes

**TODO:** Implement background task registration in app

---

## Configuration

### Environment-Specific Settings

**Debug Mode (Testing):**
```swift
#if DEBUG
static let baseURL = "http://192.168.1.100:3000/api/v1"
#endif
```

**Release Mode (Production):**
```swift
#else
static let baseURL = "https://your-production-api.com/api/v1"
#endif
```

---

### User ID Management

**Current:** User ID is hardcoded in API calls (e.g., `"test-user-123"`)

**TODO:** Implement proper user authentication and ID generation:
- Generate unique device ID
- Or implement login/signup flow
- Store user ID securely in Keychain

---

## Building & Running

### Prerequisites

- ✅ Xcode 15.0+
- ✅ iOS 16.0+ device (Screen Time APIs don't work in simulator)
- ✅ Backend API running (`npm run dev` in backend folder)
- ✅ Mac and iPhone on same WiFi network

---

### Build Steps

1. **Open Project:**
   ```bash
   open /Users/campbellerickson/Desktop/Code/screen-budget/ios/ScreenTimeBudget.xcodeproj
   ```

2. **Select Target:**
   - Click device selector at top
   - Choose your connected iPhone

3. **Build & Run:**
   - Click ▶️ Run button (or ⌘R)
   - Xcode installs app on iPhone
   - App launches automatically

---

### First Run Setup

**On iPhone:**

1. **Trust Developer:**
   - Settings → General → VPN & Device Management
   - Trust "Campbell Erickson" certificate

2. **Grant Permissions:**
   - Screen Time permission dialog appears
   - Tap "Allow"

3. **Enable Notifications:**
   - Notification permission dialog appears
   - Tap "Allow"

---

### Troubleshooting Build Issues

**Error: "Signing for 'ScreenTimeBudget' requires a development team"**
- Solution: Select your Apple ID in Signing & Capabilities → Team

**Error: "Communication with Apple failed"**
- Solution: Connect iPhone, unlock it, trust computer

**Error: "No profiles found"**
- Solution: Connect physical device, Xcode will auto-generate profiles

---

## What's Implemented

### ✅ Complete (Backend + Models)

| Feature | Status | Location |
|---------|--------|----------|
| Data Models | ✅ Complete | `Models/` |
| API Service | ✅ Complete | `Services/APIService.swift` |
| Constants & Config | ✅ Complete | `Utilities/Constants.swift` |
| Xcode Project Setup | ✅ Complete | Project file |
| iOS Capabilities | ✅ Configured | Signing & Capabilities |
| Info.plist Permissions | ✅ Added | Info tab |
| Device Activity Extension | ✅ Created | ScreenTimeReportExtension |
| Backend API | ✅ Running | `backend/src/` |
| PostgreSQL Database | ✅ Running | Docker container |

---

### ⏳ Not Yet Implemented (Views & Logic)

| Feature | Status | Needed For |
|---------|--------|------------|
| Views (UI) | ❌ Not started | User interface |
| ViewModels | ❌ Not started | Business logic |
| Screen Time monitoring | ❌ Not started | Usage tracking |
| Background sync | ❌ Not started | Auto data sync |
| Notification handling | ❌ Not started | Alert delivery |
| Onboarding flow | ❌ Not started | First-time setup |
| Budget setup UI | ❌ Not started | Create budgets |
| Dashboard UI | ❌ Not started | View usage |
| Settings screen | ❌ Not started | App config |

---

### Next Implementation Steps (Priority Order)

1. **Create Onboarding Flow**
   - Request Screen Time permission
   - Request Notification permission
   - File: `Views/OnboardingView.swift`

2. **Implement Budget Setup**
   - Category selection
   - Monthly hours input
   - Save to backend
   - File: `Views/BudgetSetupView.swift` + `ViewModels/BudgetViewModel.swift`

3. **Build Dashboard**
   - Display usage data
   - Progress bars
   - Category breakdowns
   - File: `Views/DashboardView.swift` + `ViewModels/UsageViewModel.swift`

4. **Add Screen Time Monitoring**
   - Request usage data from iOS
   - File: `Services/ScreenTimeService.swift`

5. **Implement Background Sync**
   - Register background task
   - Schedule every 15 min
   - File: `Services/BackgroundSyncService.swift`

6. **Add Notifications**
   - Local notification registration
   - Alert display
   - File: `Services/NotificationService.swift`

---

## Known Limitations

### iOS Restrictions

1. **Simulator Testing:** Screen Time APIs don't work in iOS Simulator - must use physical device
2. **Background Execution:** iOS limits background execution - sync may not always run every 15 min
3. **Battery Impact:** Background monitoring uses battery - iOS may throttle if excessive
4. **Personal Team Limitations:** Free Apple Developer accounts can't use Family Controls in production (need paid $99/year account for App Store)

---

### Current App Limitations

1. **No UI Yet:** Only models/services implemented, no views
2. **Hardcoded User ID:** No authentication system yet
3. **No Data Persistence:** App doesn't cache data locally (always fetches from backend)
4. **No Error Handling UI:** Errors are thrown but not displayed to user
5. **No Offline Support:** App requires internet connection to function

---

### Backend Limitations

1. **Single User:** Backend supports multiple users but app only uses one hardcoded ID
2. **Timezone Issues:** Minor timezone handling issue in backend (non-blocking)
3. **No User Management:** No signup/login endpoints yet

---

## Troubleshooting

### App Won't Build

**Check:**
- ✅ Xcode 15.0+ installed?
- ✅ Physical iOS device connected?
- ✅ Device iOS 16.0+?
- ✅ Device unlocked and trusted?
- ✅ Signing & Capabilities configured?

---

### Screen Time Permission Denied

**Reasons:**
- Device has Screen Time disabled in Settings
- Device has parental controls enabled
- User denied permission

**Fix:**
- Settings → Screen Time → Enable
- Uninstall app, reinstall, try again

---

### Can't Connect to Backend

**Check:**
- ✅ Backend running? (`npm run dev`)
- ✅ Backend on port 3000? (`curl http://localhost:3000/health`)
- ✅ iPhone and Mac on same WiFi?
- ✅ Constants.swift has correct IP address?
- ✅ Mac firewall not blocking port 3000?

**Test Backend:**
```bash
# On Mac
curl http://localhost:3000/health

# Should return:
{"status":"ok","timestamp":"2026-01-02T..."}
```

**Get Mac's IP:**
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
# Use this IP in Constants.swift
```

---

### Background Sync Not Working

**Current Status:** Not yet implemented

**When Implemented:**
- Check Background Modes capability enabled
- Check BGTaskSchedulerPermittedIdentifiers in Info.plist
- Check background task registered in code
- iOS may delay background tasks to save battery

---

## Summary

**What You Have Now:**
- ✅ Fully configured Xcode project
- ✅ All required iOS capabilities enabled
- ✅ Complete data models for budgets and usage
- ✅ API service layer for backend communication
- ✅ Backend API running with PostgreSQL
- ✅ Device Activity Extension created
- ✅ App ready to build on physical iPhone

**What You Need Next:**
- ⏳ Implement Views (UI)
- ⏳ Implement ViewModels (business logic)
- ⏳ Add Screen Time monitoring code
- ⏳ Add background sync functionality
- ⏳ Add notification handling

**Next Action:**
Connect your iPhone and build the app to verify everything is set up correctly. Once confirmed, we'll start building the UI and Screen Time integration.

---

**Questions or Issues?** Refer to the Troubleshooting section or check the main project README at `/Users/campbellerickson/Desktop/Code/screen-budget/README.md`

---

## Changelog

**January 2, 2026:**
- Initial iOS app documentation created
- Project structure documented
- All current implementations listed
- Next steps prioritized
